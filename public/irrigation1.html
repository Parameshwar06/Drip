<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #7cb342;
            --accent: #f9a825;
            --light: #f1f8e9;
            --dark: #1b5e20;
            --gray: #f5f5f5;
            --text: #333;
            --water-blue: #2196f3;
            --waste-red: #f44336;
            --efficiency-green: #4caf50;
            --temp-orange: #ff9800;
            --moisture-brown: #8d6e63;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 50px;
            margin-right: 10px;
        }
        
        .logo h1 {
            color: var(--primary);
            font-size: 24px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 25px;
        }
        
        nav ul li a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: var(--secondary);
        }
        
        /* Dashboard Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
        }
        
        .time-selector {
            display: flex;
            gap: 10px;
        }
        
        .time-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .time-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .summary-card h3 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .summary-card .value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .water-value {
            color: var(--water-blue);
        }
        
        .temp-value {
            color: var(--temp-orange);
        }
        
        .moisture-value {
            color: var(--moisture-brown);
        }
        
        .summary-card .trend {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .trend.up {
            color: var(--waste-red);
        }
        
        .trend.down {
            color: var(--efficiency-green);
        }
        
        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 992px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Analysis Results */
        .analysis-results {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }
        
        .analysis-results h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result-card {
            padding: 15px;
            border-radius: 8px;
            background: var(--gray);
        }
        
        .result-card h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .irrigation-needed {
            background: #e8f5e9;
            border-left: 4px solid var(--efficiency-green);
        }
        
        .irrigation-not-needed {
            background: #ffebee;
            border-left: 4px solid var(--waste-red);
        }
        
        /* Recommendations */
        .recommendations {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }
        
        .recommendations h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .recommendation-list {
            list-style: none;
        }
        
        .recommendation-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .recommendation-list li:last-child {
            border-bottom: none;
        }
        
        .recommendation-list li i {
            color: var(--accent);
            margin-right: 10px;
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 60px 0 30px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .footer-column h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 10px;
        }
        
        .footer-column ul li a {
            color: #ddd;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-column ul li a:hover {
            color: white;
        }
        
        .social-icons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .social-icons a {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: white;
            transition: background 0.3s;
        }
        
        .social-icons a:hover {
            background: var(--primary);
        }
        
        .copyright {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin: 20px 0;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .time-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header with Navigation -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.png" alt="SlopeFlow">
                    <h1 data-translate="Smart Irrigation Analysis">Smart Irrigation Analysis</h1>
                </div>
                
                <nav>
                    <ul>
                        <li><a href="check.html" data-translate="Home">Home</a></li>
                        <li><a href="irrigation1.html" data-translate="Irrigation">Irrigation</a></li>
                        <li><a href="solarpanel1.html" data-translate="Solar Panel">Solar Panel</a></li>
                        <li><a href="report.html" data-translate="Report">Report</a></li>
                       
                    </ul>
                </nav>
                <div class="lang-selector" style="display:flex; gap:8px; align-items:center;">
                    <span data-translate="Language">Language</span>
                    <select id="language">
                        <option value="en">English</option>
                        <option value="hi">हिन्दी</option>
                        <option value="ta">தமிழ்</option>
                        <option value="te">తెలుగు</option>
                        <option value="kn">ಕನ್ನಡ</option>
                        <option value="ml">മലയാളം</option>
                        <option value="bn">বাংলা</option>
                        <option value="mr">मराठी</option>
                        <option value="gu">ગુજરાતી</option>
                        <option value="pa">ਪੰਜਾਬੀ</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Analytics Dashboard -->
    <div class="container">
        <div class="dashboard-header">
            <h2 id="irrigationTitle" data-translate="Irrigation Analysis Dashboard">Irrigation Analysis Dashboard</h2>
            <div style="display:flex; gap:12px; align-items:center;">
                <div class="time-selector">
                    <button class="time-btn active" data-period="today" data-translate="Today">Today</button>
                    <button class="time-btn" data-period="week" data-translate="Week">Week</button>
                    <button class="time-btn" data-period="month" data-translate="Month">Month</button>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <label for="irrigationLocation" data-translate="Location">Location</label>:
                    <select id="irrigationLocation" style="padding:6px; min-width:220px;">
                        <option value="auto" data-translate="Use my location">Use my location</option>
                    </select>
                    <span id="irrigationLocationName" style="font-size:12px; color:#555; margin-left:6px;"></span>
                </div>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <h3 data-translate="Soil Moisture Level">Soil Moisture Level</h3>
                <div class="value moisture-value">42%</div>
                <div class="trend down">
                    <i class="fas fa-arrow-down"></i> <span data-translate="% decrease from yesterday">8% decrease from yesterday</span>
                </div>
            </div>
            <div class="summary-card">
                <h3 data-translate="Temperature">Temperature</h3>
                <div class="value temp-value" id="tempValue">32°C</div>
                <div class="trend up">
                    <i class="fas fa-arrow-up"></i> <span data-translate="°C higher than average">3°C higher than average</span>
                </div>
            </div>
            <div class="summary-card">
                <h3 data-translate="Humidity">Humidity</h3>
                <div class="value water-value" id="humidityValue">65%</div>
                <div class="trend down">
                    <i class="fas fa-arrow-down"></i> <span data-translate="% lower than yesterday">5% lower than yesterday</span>
                </div>
            </div>
            <div class="summary-card">
                <h3 data-translate="Irrigation Needed">Irrigation Needed</h3>
                <div class="value" style="color: var(--efficiency-green);">Yes</div>
                <div class="trend">
                    <i class="fas fa-tint"></i> <span data-translate="L recommended">380L recommended</span>
                </div>
            </div>
        </div>
        
        <!-- Analysis Results -->
        <div class="analysis-results">
            <h3 data-translate="Irrigation Analysis Results">Irrigation Analysis Results</h3>
            <div class="result-grid">
                <div class="result-card irrigation-needed" id="irrigationResultCard">
                    <h4><i class="fas fa-check-circle"></i> <span data-translate="Irrigation Recommended">Irrigation Recommended</span></h4>
                    <p id="irrigationDecisionText">Based on current soil moisture levels and weather conditions, irrigation is recommended today.</p>
                    <p><strong data-translate="Optimal time:">Optimal time:</strong> <span id="optimalTimeText">5:00 AM - 7:00 AM</span></p>
                </div>
                <div class="result-card">
                    <h4><i class="fas fa-cloud-sun"></i> <span data-translate="Weather Impact">Weather Impact</span></h4>
                    <p id="weatherImpactText">High temperatures and low humidity are increasing evaporation rates.</p>
                    <p><strong data-translate="Forecast:">Forecast:</strong> <span id="forecastText">No rain expected in next 48 hours</span></p>
                </div>
                <div class="result-card">
                    <h4><i class="fas fa-seedling"></i> <span data-translate="Crop Water Needs">Crop Water Needs</span></h4>
                    <p data-translate="Your crops currently need 380L of water to maintain optimal growth conditions.">Your crops currently need 380L of water to maintain optimal growth conditions.</p>
                    <p><strong data-translate="Crop stage:">Crop stage:</strong> <span data-translate="Vegetative growth">Vegetative growth</span></p>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3 data-translate="Soil Moisture Levels">Soil Moisture Levels</h3>
                <div class="chart-container">
                    <canvas id="moistureChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 data-translate="Temperature & Humidity">Temperature & Humidity</h3>
                <div class="chart-container">
                    <canvas id="tempHumidityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 data-translate="Irrigation History">Irrigation History</h3>
                <div class="chart-container">
                    <canvas id="irrigationChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 data-translate="Water Usage Efficiency">Water Usage Efficiency</h3>
                <div class="chart-container">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="recommendations">
            <h3 data-translate="Irrigation Recommendations">Irrigation Recommendations</h3>
            <ul class="recommendation-list">
                <li>
                    <i class="fas fa-tint"></i>
                    <div>
                        <strong data-translate="Optimal irrigation time:">Optimal irrigation time:</strong> <span id="recOptimalTime">Water between 5:00 AM - 7:00 AM to reduce evaporation loss</span>
                    </div>
                </li>
                <li>
                    <i class="fas fa-cloud-rain"></i>
                    <div>
                        <strong data-translate="Water amount:">Water amount:</strong> <span id="recWaterAmount">Apply 380L of water across all zones</span>
                    </div>
                </li>
                <li>
                    <i class="fas fa-sliders-h"></i>
                    <div>
                        <strong data-translate="Zone adjustment:">Zone adjustment:</strong> <span data-translate="Increase watering in Zone B by 15% where soil is drier">Increase watering in Zone B by 15% where soil is drier</span>
                    </div>
                </li>
                <li>
                    <i class="fas fa-wind"></i>
                    <div>
                        <strong data-translate="Weather note:">Weather note:</strong> <span data-translate="Higher temperatures may require additional watering tomorrow">Higher temperatures may require additional watering tomorrow</span>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3 data-translate="Smart Irrigation">Smart Irrigation</h3>
                    <p data-translate="Intelligent irrigation analysis based on soil moisture, temperature, and weather conditions.">Intelligent irrigation analysis based on soil moisture, temperature, and weather conditions.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3 data-translate="Quick Links">Quick Links</h3>
                    <ul>
                        <li><a href="check.html" data-translate="Home">Home</a></li>
                        <li><a href="irrigation1.html" data-translate="Irrigation">Irrigation</a></li>
                        <li><a href="solarpanel1.html" data-translate="Solar Panel">Solar Panel</a></li>
                        <li><a href="report.html" data-translate="Report">Report</a></li>
            
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3 data-translate="Resources">Resources</h3>
                    <ul>
                        <li><a href="#" data-translate="Irrigation Guide">Irrigation Guide</a></li>
                        <li><a href="#" data-translate="Crop Water Needs">Crop Water Needs</a></li>
                        <li><a href="#" data-translate="Weather Integration">Weather Integration</a></li>
                        <li><a href="#" data-translate="Mobile App">Mobile App</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3 data-translate="Contact Us">Contact Us</h3>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> 123 FarmTech Avenue, AgriZone</li>
                        <li><i class="fas fa-phone"></i> +1 234 567 8900</li>
                        <li><i class="fas fa-envelope"></i> support@smartirrigation.com</li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2025 Smart Irrigation Analysis. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Translation setup (similar to new.html)
        const translateApiUrl = "https://api.mymemory.translated.net/get";
        const translateCache = {};
        function getLangIrr(){ const s = document.getElementById('language'); return s ? s.value : 'en'; }
        async function translateTextIrr(text, lang){
            if (!text) return text;
            if (lang === 'en') return text;
            const key = `${lang}:${text}`;
            if (translateCache[key]) return translateCache[key];
            try {
                const r = await fetch(`${translateApiUrl}?q=${encodeURIComponent(text)}&langpair=en|${lang}`);
                const j = await r.json();
                const t = j?.responseData?.translatedText || text;
                translateCache[key] = t; return t;
            } catch (_) { return text; }
        }
        async function translatePageIrr(lang){
            const elements = document.querySelectorAll('[data-translate]');
            for (const el of elements){
                const base = el.getAttribute('data-translate');
                if (!base) continue;
                if (lang === 'en') el.innerText = base; else el.innerText = await translateTextIrr(base, lang);
            }
            translateIrrigationLocationUI(lang);
            translateDynamicIrrigationTexts(lang);
            // Translate title base
            const title = document.getElementById('irrigationTitle');
            if (title){
                const base = title.getAttribute('data-translate') || 'Irrigation Analysis Dashboard';
                const loc = (document.getElementById('irrigationLocationName')?.innerText || '').trim();
                const t = lang === 'en' ? base : await translateTextIrr(base, lang);
                title.innerText = loc ? `${t} — ${loc}` : t;
            }
            // Translate charts
            await updateChartLanguageIrr(lang);
        }
        function translateIrrigationLocationUI(lang){
            const sel = document.getElementById('irrigationLocation'); if (!sel) return;
            Array.from(sel.options).forEach(async (opt)=>{
                const key = opt.getAttribute('data-translate'); if (!key) return;
                opt.text = lang === 'en' ? key : await translateTextIrr(key, lang);
            });
            const label = document.querySelector('label[for="irrigationLocation"]');
            if (label){
                const key = label.getAttribute('data-translate') || 'Location';
                const translated = lang === 'en' ? key : null;
                if (translated) label.firstChild.nodeValue = translated; else translateTextIrr(key, lang).then(t=>{ label.firstChild.nodeValue = t; });
            }
        }
        function translateDynamicIrrigationTexts(lang){
            const ids = ['irrigationDecisionText','weatherImpactText','forecastText','recOptimalTime','recWaterAmount'];
            ids.forEach(async id=>{
                const el = document.getElementById(id); if (!el) return;
                const text = el.innerText.trim(); if (!text) return;
                if (lang === 'en') return; else el.innerText = await translateTextIrr(text, lang);
            });
        }

        async function updateChartLanguageIrr(lang){
            try {
                // Moisture chart labels
                if (window.moistureChart) {
                    const moLabel = 'Soil Moisture %';
                    window.moistureChart.data.datasets[0].label = lang === 'en' ? moLabel : await translateTextIrr(moLabel, lang);
                    const yTitle = 'Moisture %';
                    window.moistureChart.options.scales.y.title.text = lang === 'en' ? yTitle : await translateTextIrr(yTitle, lang);
                    window.moistureChart.update();
                }
                // Temperature & Humidity chart
                if (window.tempHumidityChart) {
                    const tLabel = 'Temperature °C';
                    const hLabel = 'Humidity %';
                    window.tempHumidityChart.data.datasets[0].label = lang === 'en' ? tLabel : await translateTextIrr(tLabel, lang);
                    window.tempHumidityChart.data.datasets[1].label = lang === 'en' ? hLabel : await translateTextIrr(hLabel, lang);
                    window.tempHumidityChart.options.scales.y.title.text = lang === 'en' ? tLabel : await translateTextIrr(tLabel, lang);
                    window.tempHumidityChart.options.scales.y1.title.text = lang === 'en' ? hLabel : await translateTextIrr(hLabel, lang);
                    window.tempHumidityChart.update();
                }
                // Irrigation history chart
                if (window.irrigationChart) {
                    const dsLabel = 'Water Applied (L)';
                    const yTitle = 'Liters';
                    window.irrigationChart.data.datasets[0].label = lang === 'en' ? dsLabel : await translateTextIrr(dsLabel, lang);
                    window.irrigationChart.options.scales.y.title.text = lang === 'en' ? yTitle : await translateTextIrr(yTitle, lang);
                    // Translate weekday labels if present
                    const baseDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                    if (Array.isArray(window.irrigationChart.data.labels) && window.irrigationChart.data.labels.length === 7) {
                        if (lang === 'en') {
                            window.irrigationChart.data.labels = baseDays;
                        } else {
                            const tDays = await Promise.all(baseDays.map(d => translateTextIrr(d, lang)));
                            window.irrigationChart.data.labels = tDays.map((t,i)=> t || baseDays[i]);
                        }
                    }
                    window.irrigationChart.update();
                }
                // Efficiency chart labels
                if (window.efficiencyChart) {
                    const base = ['Effective Usage', 'Evaporation', 'Runoff'];
                    if (lang === 'en') {
                        window.efficiencyChart.data.labels = base;
                    } else {
                        const tl = await Promise.all(base.map(x => translateTextIrr(x, lang)));
                        window.efficiencyChart.data.labels = tl.map((t,i)=> t || base[i]);
                    }
                    window.efficiencyChart.update();
                }
            } catch (_) { /* no-op */ }
        }

        // Weather-driven irrigation logic (minimal page changes)
        const WEATHER_API_KEY = "df805452e2a0b8e016a98adf1f59820a"; // reuse key
        const WEATHER_API_URL = "https://api.openweathermap.org/data/2.5/weather";
        const FORECAST_API_URL = "https://api.openweathermap.org/data/2.5/forecast";
        const GEO_REVERSE_URL = "https://api.openweathermap.org/geo/1.0/reverse";
        let lat = 12.9716, lon = 77.5946; // default Bengaluru
        const presetLocations = [
            { name: 'Bengaluru, IN', lat: 12.9716, lon: 77.5946 },
            { name: 'Hyderabad, IN', lat: 17.3850, lon: 78.4867 },
            { name: 'Mumbai, IN', lat: 19.0760, lon: 72.8777 },
            { name: 'Delhi, IN', lat: 28.6139, lon: 77.2090 },
            { name: 'Chennai, IN', lat: 13.0827, lon: 80.2707 },
            { name: 'Kolkata, IN', lat: 22.5726, lon: 88.3639 },
            { name: 'Pune, IN', lat: 18.5204, lon: 73.8567 },
            { name: 'Ahmedabad, IN', lat: 23.0225, lon: 72.5714 }
        ];
        document.addEventListener('DOMContentLoaded', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    lat = pos.coords.latitude; lon = pos.coords.longitude; fetchIrrigationWeather(); updateIrrigationLocationName();
                    syncIrrigationTitle();
                }, () => fetchIrrigationWeather());
            } else {
                fetchIrrigationWeather();
            }
            populateIrrigationLocationDropdown();
            attachIrrigationLocationHandler();
            const langSel = document.getElementById('language');
            if (langSel){
                const saved = localStorage.getItem('preferredLanguageIrr');
                if (saved){ langSel.value = saved; }
                translatePageIrr(getLangIrr());
                langSel.addEventListener('change', (e)=>{
                    const lang = e.target.value; localStorage.setItem('preferredLanguageIrr', lang); translatePageIrr(lang);
                });
            }
        });

        function populateIrrigationLocationDropdown() {
            const sel = document.getElementById('irrigationLocation');
            if (!sel) return;
            presetLocations.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = `${loc.lat},${loc.lon}`;
                opt.setAttribute('data-translate', loc.name);
                opt.textContent = loc.name;
                sel.appendChild(opt);
            });
            translateIrrigationLocationUI(getLangIrr());
        }

        function attachIrrigationLocationHandler() {
            const sel = document.getElementById('irrigationLocation');
            if (!sel) return;
            sel.addEventListener('change', () => {
                const val = sel.value;
                if (val === 'auto') {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            lat = pos.coords.latitude; lon = pos.coords.longitude; fetchIrrigationWeather(); updateIrrigationLocationName();
                            syncIrrigationTitle();
                        }, () => fetchIrrigationWeather());
                    } else {
                        fetchIrrigationWeather();
                    }
                } else {
                    const [la, lo] = val.split(',');
                    lat = parseFloat(la); lon = parseFloat(lo);
                    fetchIrrigationWeather(); setIrrigationLocationNameFromPreset(); syncIrrigationTitle();
                }
            });
        }

        function setIrrigationLocationNameFromPreset() {
            const span = document.getElementById('irrigationLocationName');
            const sel = document.getElementById('irrigationLocation');
            if (!span || !sel) return;
            const opt = sel.options[sel.selectedIndex];
            span.innerText = opt && opt.text ? opt.text : '';
        }

        async function updateIrrigationLocationName() {
            const span = document.getElementById('irrigationLocationName');
            if (!span) return;
            try {
                const res = await fetch(`${GEO_REVERSE_URL}?lat=${lat}&lon=${lon}&limit=1&appid=${WEATHER_API_KEY}`);
                if (res.ok) {
                    const arr = await res.json();
                    if (Array.isArray(arr) && arr[0]) {
                        const place = arr[0];
                        const city = place.name || '';
                        const state = place.state || '';
                        const country = place.country || '';
                        const label = [city, state].filter(Boolean).join(', ') || city || state || '';
                        span.innerText = label ? `${label}${country ? `, ${country}` : ''}` : `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
                        syncIrrigationTitle();
                        return;
                    }
                }
                span.innerText = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
                syncIrrigationTitle();
            } catch (_) {
                span.innerText = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
                syncIrrigationTitle();
            }
        }

        function syncIrrigationTitle() {
            const titleEl = document.getElementById('irrigationTitle');
            const locEl = document.getElementById('irrigationLocationName');
            if (!titleEl) return;
            const base = 'Irrigation Analysis Dashboard';
            const loc = (locEl && locEl.innerText.trim()) || '';
            titleEl.innerText = loc ? `${base} — ${loc}` : base;
        }

        async function fetchIrrigationWeather() {
            try {
                const curRes = await fetch(`${WEATHER_API_URL}?lat=${lat}&lon=${lon}&units=metric&appid=${WEATHER_API_KEY}`);
                if (!curRes.ok) throw new Error('weather');
                const cur = await curRes.json();
                const fcRes = await fetch(`${FORECAST_API_URL}?lat=${lat}&lon=${lon}&units=metric&appid=${WEATHER_API_KEY}`);
                const fc = fcRes.ok ? await fcRes.json() : null;
                applyIrrigationRecommendations(cur, fc);
            } catch (_) {
                // fallback sample
                applyIrrigationRecommendations({ main: { temp: 30, humidity: 60 } }, null);
            }
        }

        function applyIrrigationRecommendations(current, forecast) {
            const tempC = Math.round(current?.main?.temp ?? 30);
            const humidity = Math.round(current?.main?.humidity ?? 60);
            const isHot = tempC >= 33;
            const isDryAir = humidity <= 45;
            const rainSoon = willRainSoon(forecast);

            const optimalWindow = computeOptimalWindow(tempC);
            const irrigationNeeded = (!rainSoon) && (isHot || isDryAir);

            // Update summary tiles
            const tEl = document.getElementById('tempValue'); if (tEl) tEl.innerText = `${tempC}°C`;
            const hEl = document.getElementById('humidityValue'); if (hEl) hEl.innerText = `${humidity}%`;

            // Update analysis section
            const card = document.getElementById('irrigationResultCard');
            const decision = document.getElementById('irrigationDecisionText');
            const optTime = document.getElementById('optimalTimeText');
            if (card && decision && optTime) {
                const locPrefix = getCurrentLocationLabel();
                if (irrigationNeeded) {
                    card.classList.add('irrigation-needed');
                    card.classList.remove('irrigation-not-needed');
                    decision.innerText = `${locPrefix}Irrigation is recommended today given current conditions.`;
                } else {
                    card.classList.remove('irrigation-needed');
                    card.classList.add('irrigation-not-needed');
                    decision.innerText = `${locPrefix}Irrigation is not necessary right now due to expected conditions.`;
                }
                optTime.innerText = optimalWindow;
            }

            const impact = document.getElementById('weatherImpactText');
            const fcText = document.getElementById('forecastText');
            if (impact) {
                impact.innerText = `${getCurrentLocationLabel()}${isHot || isDryAir ? 'Higher evapotranspiration expected due to heat/dry air.' : 'Mild conditions with moderate evaporation.'}`;
            }
            if (fcText) {
                fcText.innerText = `${getCurrentLocationLabel()}${rainSoon ? 'Rain likely within 24 hours' : 'No significant rain expected soon'}`;
            }
            // Re-translate dynamic texts according to current language
            translateDynamicIrrigationTexts(getLangIrr());

            // Update recommendation list
            const recTime = document.getElementById('recOptimalTime');
            const recWater = document.getElementById('recWaterAmount');
            if (recTime) recTime.innerText = `Water between ${optimalWindow} to reduce evaporation loss`;
            if (recWater) {
                const baseLiters = 380;
                const adj = isHot ? 1.1 : 1.0; // +10% if hot
                recWater.innerText = `Apply ${Math.round(baseLiters * adj)}L of water across all zones`;
            }
        }

        function getCurrentLocationLabel() {
            const locEl = document.getElementById('irrigationLocationName');
            const text = (locEl && locEl.innerText.trim()) || '';
            return text ? `${text}: ` : '';
        }

        function willRainSoon(forecast) {
            try {
                const list = forecast?.list || [];
                // next 8 entries ~ 24 hours
                return list.slice(0, 8).some(it => (it?.weather?.[0]?.main === 'Rain') || (it?.pop >= 0.5));
            } catch (_) { return false; }
        }

        function computeOptimalWindow(tempC) {
            // Prefer early morning/evening; shift later if unusually cool
            if (tempC >= 30) return '5:00 AM - 7:00 AM';
            if (tempC >= 25) return '6:00 AM - 8:00 AM';
            return '6:30 AM - 8:30 AM';
        }
        // Time selector functionality
        document.querySelectorAll('.time-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                updateCharts(this.textContent.toLowerCase());
            });
        });
        
        // Function to update charts based on selected time period
        function updateCharts(period) {
            // In a real application, this would fetch new data from an API
            console.log(`Updating charts for ${period} view`);
            
            // Update chart data based on period
            if (period === 'today') {
                moistureChart.data.datasets[0].data = [45, 42, 40, 38, 36, 35, 38, 42, 45, 48, 50, 52];
                moistureChart.update();
                
                tempHumidityChart.data.datasets[0].data = [22, 21, 20, 22, 25, 28, 31, 32, 31, 29, 26, 24];
                tempHumidityChart.data.datasets[1].data = [80, 82, 85, 80, 70, 60, 55, 50, 55, 65, 75, 80];
                tempHumidityChart.update();
            } else if (period === 'week') {
                // Update for weekly view
                moistureChart.data.labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                moistureChart.data.datasets[0].data = [48, 45, 42, 40, 38, 42, 45];
                moistureChart.update();
                
                tempHumidityChart.data.labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                tempHumidityChart.data.datasets[0].data = [28, 30, 32, 31, 29, 28, 27];
                tempHumidityChart.data.datasets[1].data = [65, 60, 55, 60, 65, 70, 75];
                tempHumidityChart.update();
            } else if (period === 'month') {
                // Update for monthly view
                moistureChart.data.labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                moistureChart.data.datasets[0].data = [45, 42, 38, 35];
                moistureChart.update();
                
                tempHumidityChart.data.labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                tempHumidityChart.data.datasets[0].data = [28, 30, 32, 31];
                tempHumidityChart.data.datasets[1].data = [70, 65, 60, 65];
                tempHumidityChart.update();
            }
        }
        
        // Chart initialization
        // Soil Moisture Chart
        const moistureCtx = document.getElementById('moistureChart').getContext('2d');
        const moistureChart = new Chart(moistureCtx, {
            type: 'line',
            data: {
                labels: ['12AM', '2AM', '4AM', '6AM', '8AM', '10AM', '12PM', '2PM', '4PM', '6PM', '8PM', '10PM'],
                datasets: [{
                    label: 'Soil Moisture %',
                    data: [45, 42, 40, 38, 36, 35, 38, 42, 45, 48, 50, 52],
                    borderColor: '#8d6e63',
                    backgroundColor: 'rgba(141, 110, 99, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        min: 30,
                        max: 60,
                        title: {
                            display: true,
                            text: 'Moisture %'
                        }
                    }
                }
            }
        });
        
        // Temperature & Humidity Chart
        const tempHumidityCtx = document.getElementById('tempHumidityChart').getContext('2d');
        const tempHumidityChart = new Chart(tempHumidityCtx, {
            type: 'line',
            data: {
                labels: ['12AM', '2AM', '4AM', '6AM', '8AM', '10AM', '12PM', '2PM', '4PM', '6PM', '8PM', '10PM'],
                datasets: [
                    {
                        label: 'Temperature °C',
                        data: [22, 21, 20, 22, 25, 28, 31, 32, 31, 29, 26, 24],
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Humidity %',
                        data: [80, 82, 85, 80, 70, 60, 55, 50, 55, 65, 75, 80],
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature °C'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 40,
                        max: 90,
                        title: {
                            display: true,
                            text: 'Humidity %'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
        
        // Irrigation History Chart
        const irrigationCtx = document.getElementById('irrigationChart').getContext('2d');
        const irrigationChart = new Chart(irrigationCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Water Applied (L)',
                    data: [400, 0, 380, 0, 420, 0, 380],
                    backgroundColor: 'rgba(33, 150, 243, 0.7)',
                    borderColor: '#2196f3',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Liters'
                        }
                    }
                }
            }
        });
        
        // Efficiency Chart
        const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
        const efficiencyChart = new Chart(efficiencyCtx, {
            type: 'doughnut',
            data: {
                labels: ['Effective Usage', 'Evaporation', 'Runoff'],
                datasets: [{
                    data: [75, 15, 10],
                    backgroundColor: ['#4caf50', '#ff9800', '#f44336'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Initialize with today's data
        updateCharts('today');
    </script>
</body>
</html>